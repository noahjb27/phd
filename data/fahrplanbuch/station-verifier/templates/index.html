<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Location Verifier</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Draw Plugin CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <div id="container">
        <!-- Tabbed Sidebar Structure -->
        <div id="sidebar">
            <div class="app-header">
                <h2>Station Verifier</h2>
                <p>Verify and correct station locations for historical Berlin transport</p>
            </div>
            
            <!-- Selected Station Panel - Always visible when a station is selected -->
            <div class="control-group current-station" id="current-station" style="display: none;">
                <div class="detail-header">
                    <h4 id="selected-station-name">Station Name</h4>
                    <div class="status-tag status-original" id="selected-station-status">Original</div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Dataset:</span>
                    <span class="detail-value" id="selected-station-year-side">Year/Side</span>
                </div>
                <div class="detail-info">
                    <div class="detail-row">
                        <span class="detail-label">Current:</span>
                        <span class="detail-value coord" id="selected-station-coords">0.000000, 0.000000</span>
                    </div>
                </div>
                <button id="save-correction" class="primary-button" style="display: none;">Save New Location</button>
                <button id="delete-station" class="secondary-button danger-button" style="display: none;">Delete Station</button>
                <button id="details-toggle" class="text-button">Show Full Details</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="dataset">Datasets</button>
                <button class="tab-button" data-tab="map">Map Layers</button>
                <button class="tab-button" data-tab="stations">Stations</button>
                <button class="tab-button" data-tab="tools">Tools</button>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Dataset Tab -->
                <div class="tab-pane active" id="dataset-tab">
                    <!-- First Dataset -->
                    <div class="control-group dataset-control primary-dataset">
                        <h3>Primary Dataset</h3>
                        <label for="year-select-1">Select Year/Side:</label>
                        <select id="year-select-1" class="year-select">
                            <option value="">-- Select --</option>
                            {% for year_side in year_sides %}
                            <option value="{{ year_side.id }}">{{ year_side.year }} ({{ year_side.side }})</option>
                            {% endfor %}
                        </select>
                        
                        <div class="line-filter" id="line-filter-container-1" style="display: none;">
                            <label for="line-select-1">Filter by Line:</label>
                            <select id="line-select-1" class="line-select">
                                <option value="all">All Lines</option>
                            </select>
                        </div>
                        
                        <div class="dataset-style">
                            <label for="color-select-1">Marker Color:</label>
                            <select id="color-select-1" class="color-select">
                                <option value="#3498db">Blue</option>
                                <option value="#e74c3c">Red</option>
                                <option value="#2ecc71">Green</option>
                                <option value="#f39c12">Orange</option>
                                <option value="#9b59b6">Purple</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Second Dataset -->
                    <div class="control-group dataset-control">
                        <h3>Comparison Dataset</h3>
                        <label for="year-select-2">Select Year/Side:</label>
                        <select id="year-select-2" class="year-select">
                            <option value="">-- None --</option>
                            {% for year_side in year_sides %}
                            <option value="{{ year_side.id }}">{{ year_side.year }} ({{ year_side.side }})</option>
                            {% endfor %}
                        </select>
                        
                        <div class="line-filter" id="line-filter-container-2" style="display: none;">
                            <label for="line-select-2">Filter by Line:</label>
                            <select id="line-select-2" class="line-select">
                                <option value="all">All Lines</option>
                            </select>
                        </div>
                        
                        <div class="dataset-style">
                            <label for="color-select-2">Marker Color:</label>
                            <select id="color-select-2" class="color-select">
                                <option value="#e74c3c">Red</option>
                                <option value="#3498db">Blue</option>
                                <option value="#2ecc71">Green</option>
                                <option value="#f39c12">Orange</option>
                                <option value="#9b59b6">Purple</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="load-datasets-btn" class="primary-button">Load Datasets</button>
                </div>
                
                <!-- Map Layers Tab -->
                <div class="tab-pane" id="map-tab">
                    <div class="control-group">
                        <div class="toggle-option">
                            <input type="checkbox" id="osm-layer" checked>
                            <label for="osm-layer">OpenStreetMap</label>
                        </div>
                        <div class="toggle-option">
                            <input type="checkbox" id="historic-layer">
                            <label for="historic-layer">Historical Map</label>
                        </div>
                        <div id="historic-layer-selector" style="display: none;">
                            <select id="historic-map-select">
                                <option value="">Loading tile sets...</option>
                            </select>
                            <div class="opacity-slider">
                                <label for="opacity-slider">Opacity: <span id="opacity-value">70%</span></label>
                                <input type="range" id="opacity-slider" min="0.1" max="1.0" step="0.1" value="0.7">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stations Tab -->
                <div class="tab-pane" id="stations-tab">
                    <div class="control-group station-list-container">
                        <div class="search-container">
                            <input type="text" id="station-search" placeholder="Search stations...">
                        </div>
                        <div class="dataset-switcher" id="station-list-datasets">
                            <div class="btn-group">
                                <button class="btn btn-sm active" data-dataset="1">Dataset 1</button>
                                <button class="btn btn-sm" data-dataset="2">Dataset 2</button>
                            </div>
                        </div>
                        <div class="station-list" id="station-list"></div>
                    </div>
                </div>
                
                <!-- Tools Tab -->
                <div class="tab-pane" id="tools-tab">
                    <div class="control-group export-controls">
                        <button id="export-btn" class="primary-button">Export Corrected Data</button>
                        <button id="add-station-btn" class="secondary-button">Add New Station</button>
                        <button id="process-tif-btn" class="secondary-button">Process TIF Files</button>
                        <div id="process-status" class="status-indicator"></div>
                    </div>
                    
                    <!-- Full Station Details (moved here from always-visible area) -->
                    <div class="control-group" id="full-station-details" style="display: none;">
                        <h3>Station Details</h3>
                        <div id="station-details"></div>
                        
                        <!-- Station Name Editing -->
                        <div class="detail-row">
                            <span class="detail-label">Name:</span>
                            <br>
                            <div class="detail-value name-edit">
                                <div class="name-input-container">
                                    <input type="text" id="station-name-input" class="station-name-input">
                                </div>
                                <div class="name-edit-buttons">
                                    <button id="edit-name-btn" class="text-button">Edit</button>
                                    <button id="save-name-btn" class="text-button" style="display: none;">Save Name</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Station Source Editing -->
                        <div class="detail-row">
                            <span class="detail-label">Source:</span>
                            <br>
                            <div class="detail-value source-edit">
                                <div class="source-input-container">
                                    <input type="text" id="station-source-input" class="station-source-input" placeholder="Enter data source...">
                                </div>
                                <div class="source-edit-buttons">
                                    <button id="edit-source-btn" class="text-button">Edit</button>
                                    <button id="save-source-btn" class="text-button" style="display: none;">Save Source</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
        
        <!-- Mobile Toggle -->
        <div class="mobile-toggle" id="mobile-toggle">
            <span class="toggle-icon">▲</span>
        </div>
        
        <!-- Add Station Modal -->
        <div id="add-station-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3>Add New Station</h3>
                <div class="form-group">
                    <label for="new-station-name">Station Name:</label>
                    <input type="text" id="new-station-name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="new-station-type">Station Type:</label>
                    <select id="new-station-type" class="form-control">
                        <option value="ubahn">U-Bahn</option>
                        <option value="sbahn">S-Bahn</option>
                        <option value="tram">Tram</option>
                        <option value="bus">Bus</option>
                        <option value="faehre">Fähre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-station-year-side">Dataset:</label>
                    <select id="new-station-year-side" class="form-control">
                        <!-- Will be populated dynamically based on selected datasets -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-station-line">Connect to Line (Optional):</label>
                    <select id="new-station-line" class="form-control">
                        <option value="">-- None --</option>
                        <!-- Will be populated dynamically based on selected dataset -->
                    </select>
                </div>
                <div class="form-group" id="stop-order-container" style="display: none;">
                    <label for="new-station-stop-order">Stop Order:</label>
                    <input type="number" id="new-station-stop-order" class="form-control" min="1">
                </div>
                <div class="form-group">
                    <label>Station Location:</label>
                    <p class="help-text">Click on the map to set the location for the new station.</p>
                    <div class="coords-display" id="new-station-coords">Not set</div>
                </div>
                <button id="create-station-btn" class="primary-button" disabled>Create Station</button>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3 id="confirm-title">Confirm Action</h3>
                <p id="confirm-message">Are you sure you want to perform this action?</p>
                <div class="button-group">
                    <button id="confirm-cancel" class="secondary-button">Cancel</button>
                    <button id="confirm-ok" class="primary-button danger-button">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Map initialization
        const map = L.map('map').setView([52.5200, 13.4050], 12);  // Berlin center
        
        // Base layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Define custom marker factory
        function createMarkerIcon(color, isSelected, isCorrected) {
            // Convert hex to RGB for CSS
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };
            
            const rgb = hexToRgb(color);
            const colorStyle = rgb ? `background-color: rgb(${rgb.r}, ${rgb.g}, ${rgb.b})` : `background-color: ${color}`;
            
            const className = `${isSelected ? 'selected' : ''} ${isCorrected ? 'corrected' : ''}`.trim();
            const sizeClass = isSelected ? 'size-large' : 'size-normal';
            
            return L.divIcon({
                html: `<div class="station-marker ${className} ${sizeClass}" style="${colorStyle}"></div>`,
                className: '',
                iconSize: isSelected ? [16, 16] : [12, 12]
            });
        }

        // Historical tile layer state
        let historicalLayer = null;
        let availableTileSets = [];

        // Variables for app state
        let datasets = {
            1: { yearSide: null, lineFilter: 'all', color: '#3498db', markers: L.layerGroup(), data: null },
            2: { yearSide: null, lineFilter: 'all', color: '#e74c3c', markers: L.layerGroup(), data: null }
        };
        
        let selectedStation = null;
        let selectedMarker = null;
        let markerDraggedPosition = null;
        let corrections = {};
        let newStationMode = false;
        let newStationPosition = null;
        let selectedInsertionPoint = null;
        
        // Add marker layers to map
        datasets[1].markers.addTo(map);
        datasets[2].markers.addTo(map);
        
        // Fetch available tile sets when page loads
        fetch('/available_tile_sets')
            .then(response => response.json())
            .then(data => {
                availableTileSets = data;
                
                // Update the historic map options in the dropdown
                const historicMapSelect = document.getElementById('historic-map-select');
                historicMapSelect.innerHTML = '';
                
                if (data.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No tile sets available - process TIF files first';
                    historicMapSelect.appendChild(option);
                } else {
                    data.forEach(tileSet => {
                        const option = document.createElement('option');
                        option.value = tileSet.name;
                        option.textContent = tileSet.name;
                        option.dataset.url = tileSet.url;
                        option.dataset.minZoom = Math.min(...tileSet.zoom_levels);
                        option.dataset.maxZoom = Math.max(...tileSet.zoom_levels);
                        historicMapSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error fetching tile sets:', error));

        // Fetch all existing corrections
        fetch('/get_corrections')
            .then(response => response.json())
            .then(data => {
                corrections = data;
            })
            .catch(error => console.error('Error fetching corrections:', error));
        
        // Layer control toggle events
        document.getElementById('osm-layer').addEventListener('change', function(e) {
            if(e.target.checked) {
                map.addLayer(osmLayer);
            } else {
                map.removeLayer(osmLayer);
            }
        });
        
        document.getElementById('historic-layer').addEventListener('change', function(e) {
            const historicLayerSelector = document.getElementById('historic-layer-selector');
            
            if(e.target.checked) {
                historicLayerSelector.style.display = 'block';
                updateHistoricalLayer();
            } else {
                historicLayerSelector.style.display = 'none';
                
                // Remove historical layer if it exists
                if (historicalLayer && map.hasLayer(historicalLayer)) {
                    map.removeLayer(historicalLayer);
                    historicalLayer = null;
                }
            }
        });
        
        document.getElementById('historic-map-select').addEventListener('change', updateHistoricalLayer);
        
        // Update Color Event Listeners
        document.querySelectorAll('.color-select').forEach(select => {
            select.addEventListener('change', function() {
                const datasetId = this.id.split('-')[2];
                datasets[datasetId].color = this.value;
                
                // If dataset is already loaded, update markers
                if (datasets[datasetId].yearSide) {
                    updateDatasetMarkers(datasetId);
                }
            });
        });
        
        // Year Selection Event Listeners
        document.querySelectorAll('.year-select').forEach(select => {
            select.addEventListener('change', function() {
                const datasetId = this.id.split('-')[2];
                const yearSide = this.value;
                
                // Clear related line filter
                const lineFilterContainer = document.getElementById(`line-filter-container-${datasetId}`);
                const lineSelect = document.getElementById(`line-select-${datasetId}`);
                
                lineSelect.innerHTML = '<option value="all">All Lines</option>';
                lineFilterContainer.style.display = 'none';
                
                // If a year_side is selected, fetch the lines for it
                if (yearSide) {
                    fetch(`/data/${yearSide}`)
                        .then(response => response.json())
                        .then(data => {
                            // Store line data
                            datasets[datasetId].linesData = data.lines;
                            
                            // Populate line filter dropdown
                            const uniqueLines = {};
                            data.lines.forEach(line => {
                                uniqueLines[line.line_id] = {
                                    name: line.line_name,
                                    type: line.type
                                };
                            });
                            
                            // Create a sorted array of entries first
                            const sortedLines = Object.entries(uniqueLines).sort((a, b) => {
                                // Sort by line name
                                return a[1].name.localeCompare(b[1].name);
                            });

                            // Now use the sorted array to populate the dropdown
                            sortedLines.forEach(([id, line]) => {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = `${line.name} (${line.type})`;
                                lineSelect.appendChild(option);
                            });
                            
                            lineFilterContainer.style.display = 'block';
                        })
                        .catch(error => {
                            console.error(`Error fetching lines for ${yearSide}:`, error);
                            showToast(`Error loading lines for dataset ${datasetId}`, 'error');
                        });
                }
            });
        });
        
        // Line Filter Event Listeners
        document.querySelectorAll('.line-select').forEach(select => {
            select.addEventListener('change', function() {
                const datasetId = this.id.split('-')[2];
                datasets[datasetId].lineFilter = this.value;
            });
        });
        
        // Station List Dataset Switcher
        document.querySelectorAll('#station-list-datasets .btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update button active state
                document.querySelectorAll('#station-list-datasets .btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update station list
                const datasetId = this.getAttribute('data-dataset');
                updateStationList(datasetId);
            });
        });
        
        // Load Datasets Button
        document.getElementById('load-datasets-btn').addEventListener('click', function() {
            // Gather datasets to load
            const yearSides = [];
            const lineFilters = {};
            
            // First dataset
            const yearSide1 = document.getElementById('year-select-1').value;
            if (yearSide1) {
                yearSides.push(yearSide1);
                datasets[1].yearSide = yearSide1;
                
                const lineFilter1 = document.getElementById('line-select-1').value;
                datasets[1].lineFilter = lineFilter1;
                lineFilters[yearSide1] = lineFilter1;
            } else {
                showToast('Please select a primary dataset', 'error');
                return;
            }
            
            // Second dataset (optional)
            const yearSide2 = document.getElementById('year-select-2').value;
            if (yearSide2) {
                yearSides.push(yearSide2);
                datasets[2].yearSide = yearSide2;
                
                const lineFilter2 = document.getElementById('line-select-2').value;
                datasets[2].lineFilter = lineFilter2;
                lineFilters[yearSide2] = lineFilter2;
            } else {
                // Clear dataset 2 if not selected
                datasets[2].yearSide = null;
                datasets[2].markers.clearLayers();
            }
            
            // Fetch and display data
            fetch('/multi_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year_sides: yearSides,
                    line_filters: lineFilters
                })
            })
            .then(response => response.json())
            .then(data => {
                // Process each dataset
                for (const datasetId in datasets) {
                    const yearSide = datasets[datasetId].yearSide;
                    if (yearSide && data[yearSide]) {
                        datasets[datasetId].data = data[yearSide];
                        datasets[datasetId].markers.clearLayers();
                        
                        // Update buttons for Add Station modal
                        updateAddStationDatasetSelect();
                        
                        if (data[yearSide].error) {
                            showToast(`Error in dataset ${datasetId}: ${data[yearSide].error}`, 'error');
                        } else {
                            displayDataset(datasetId);
                        }
                    }
                }
                
                // Update station list for the active dataset tab
                const activeDatasetBtn = document.querySelector('#station-list-datasets .btn.active');
                if (activeDatasetBtn) {
                    updateStationList(activeDatasetBtn.getAttribute('data-dataset'));
                } else {
                    // Default to dataset 1
                    updateStationList(1);
                }
                
                if (yearSides.length > 0) {
                    showToast('Datasets loaded successfully', 'success');
                }
            })
            .catch(error => {
                console.error('Error loading datasets:', error);
                showToast('Error loading datasets', 'error');
            });
        });
        
        // Process TIF files button
        document.getElementById('process-tif-btn').addEventListener('click', function() {
            const statusIndicator = document.getElementById('process-status');
            
            statusIndicator.className = 'status-indicator status-processing';
            statusIndicator.textContent = 'Processing TIF files... This may take several minutes.';
            
            this.disabled = true;
            
            // First fetch list of TIF files
            fetch('/list_tif_files')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        statusIndicator.className = 'status-indicator status-error';
                        statusIndicator.textContent = 'Error: ' + data.error;
                        this.disabled = false;
                        return;
                    }
                    
                    if (!data.tif_files || data.tif_files.length === 0) {
                        statusIndicator.className = 'status-indicator status-error';
                        statusIndicator.textContent = 'No TIF files found in the tiles/tif directory. Please add TIF files first.';
                        this.disabled = false;
                        return;
                    }
                    
                    // Process all TIF files
                    fetch('/process_all_tifs', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            statusIndicator.className = 'status-indicator status-success';
                            statusIndicator.textContent = result.message;
                            showToast('TIF files processed successfully', 'success');
                            
                            // Refresh available tile sets
                            fetch('/available_tile_sets')
                                .then(response => response.json())
                                .then(tilesData => {
                                    availableTileSets = tilesData;
                                    
                                    // Update the dropdown
                                    const historicMapSelect = document.getElementById('historic-map-select');
                                    historicMapSelect.innerHTML = '';
                                    
                                    if (tilesData.length === 0) {
                                        const option = document.createElement('option');
                                        option.value = '';
                                        option.textContent = 'No tile sets available';
                                        historicMapSelect.appendChild(option);
                                    } else {
                                        tilesData.forEach(tileSet => {
                                            const option = document.createElement('option');
                                            option.value = tileSet.name;
                                            option.textContent = tileSet.name;
                                            option.dataset.url = tileSet.url;
                                            option.dataset.minZoom = Math.min(...tileSet.zoom_levels);
                                            option.dataset.maxZoom = Math.max(...tileSet.zoom_levels);
                                            historicMapSelect.appendChild(option);
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Error refreshing tile sets:', error);
                                });
                        } else {
                            statusIndicator.className = 'status-indicator status-error';
                            statusIndicator.textContent = 'Error: ' + result.message;
                            showToast('Error processing TIF files', 'error');
                        }
                        
                        this.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error processing TIF files:', error);
                        statusIndicator.className = 'status-indicator status-error';
                        statusIndicator.textContent = 'An error occurred while processing TIF files.';
                        this.disabled = false;
                        showToast('Error processing TIF files', 'error');
                    });
                })
                .catch(error => {
                    console.error('Error listing TIF files:', error);
                    statusIndicator.className = 'status-indicator status-error';
                    statusIndicator.textContent = 'An error occurred while listing TIF files.';
                    this.disabled = false;
                    showToast('Error listing TIF files', 'error');
                });
        });
        
        // Station search
        document.getElementById('station-search').addEventListener('input', function(e) {
            const searchText = e.target.value.toLowerCase();
            
            const stationItems = document.querySelectorAll('.station-item');
            stationItems.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const id = item.getAttribute('data-id').toLowerCase();
                
                // Check if either name or stop_id matches the search text
                if (name.includes(searchText) || id.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Save correction button
        document.getElementById('save-correction').addEventListener('click', function() {
            if (!selectedStation || !markerDraggedPosition) return;
            
            const yearSide = selectedStation.properties.year_side;
            
            // Save correction
            fetch('/save_correction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    year_side: yearSide,
                    stop_id: selectedStation.properties.stop_id,
                    lat: markerDraggedPosition.lat,
                    lng: markerDraggedPosition.lng,
                    name: null  // Not updating name here
                })
            })
            .then(response => response.json())
            .then(data => {
                showToast('Station location saved successfully!', 'success');
                
                // Update local corrections
                if (!corrections[yearSide]) {
                    corrections[yearSide] = {};
                }
                
                if (!corrections[yearSide][selectedStation.properties.stop_id]) {
                    corrections[yearSide][selectedStation.properties.stop_id] = {};
                }
                
                // Preserve existing name if already set
                const existingName = corrections[yearSide][selectedStation.properties.stop_id].name;
                
                corrections[yearSide][selectedStation.properties.stop_id] = {
                    lat: markerDraggedPosition.lat,
                    lng: markerDraggedPosition.lng
                };
                
                // Keep name if it was previously set
                if (existingName) {
                    corrections[yearSide][selectedStation.properties.stop_id].name = existingName;
                }
                
                // Refresh display
                for (const datasetId in datasets) {
                    if (datasets[datasetId].yearSide === yearSide) {
                        displayDataset(datasetId);
                    }
                }
                
                // Reset state
                markerDraggedPosition = null;
                document.getElementById('save-correction').style.display = 'none';
                
                // Update station details
                updateStationDetails();
            })
            .catch(error => {
                console.error('Error saving correction:', error);
                showToast('Error saving station location', 'error');
            });
        });
        
        // Delete station button
        document.getElementById('delete-station').addEventListener('click', function() {
            if (!selectedStation) return;
            
            // Show confirmation dialog
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok');
            const confirmCancelBtn = document.getElementById('confirm-cancel');
            
            confirmTitle.textContent = 'Delete Station';
            confirmMessage.textContent = `Are you sure you want to delete station "${selectedStation.properties.name}"? This action cannot be undone.`;
            
            confirmOkBtn.onclick = function() {
                // Hide modal
                confirmationModal.style.display = 'none';
                
                // Send delete request
                fetch('/delete_station', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year_side: selectedStation.properties.year_side,
                        stop_id: selectedStation.properties.stop_id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Station deleted successfully', 'success');
                        
                        // Hide station details
                        document.getElementById('current-station').style.display = 'none';
                        document.getElementById('full-station-details').style.display = 'none';
                        
                        // Reset selection
                        selectedStation = null;
                        selectedMarker = null;
                        
                        // Reload datasets
                        document.getElementById('load-datasets-btn').click();
                    } else {
                        showToast(`Error deleting station: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting station:', error);
                    showToast('Error deleting station', 'error');
                });
            };
            
            confirmCancelBtn.onclick = function() {
                confirmationModal.style.display = 'none';
            };
            
            // Show modal
            confirmationModal.style.display = 'block';
        });
        
        // Export button
        document.getElementById('export-btn').addEventListener('click', function() {
            fetch('/export_corrections')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(`Exported ${data.updated_stations} station corrections to database!`, 'success');
                    } else {
                        showToast(`Export error: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error exporting data:', error);
                    showToast('Error exporting data', 'error');
                });
        });
        
        // Add Station button and modal
        document.getElementById('add-station-btn').addEventListener('click', function() {
            // Show add station modal
            const modal = document.getElementById('add-station-modal');
            modal.style.display = 'block';
            
            // Reset form
            resetNewStationMode();
            
            // Fill dataset options with currently loaded datasets
            updateAddStationDatasetSelect();
            
            // Enable new station mode for map clicking
            newStationMode = true;
            
            showToast('Click on the map to set the new station location', 'info');
        });
        
        // Close modals
        document.querySelectorAll('.close-modal').forEach(close => {
            close.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.style.display = 'none';
                
                // If closing add station modal, clean up
                if (modal.id === 'add-station-modal') {
                    resetNewStationMode();
                }
            });
        });
        
        // Dataset selection in add station modal
        document.getElementById('new-station-year-side').addEventListener('change', function() {
            const yearSide = this.value;
            const lineSelect = document.getElementById('new-station-line');
            const stopOrderContainer = document.getElementById('stop-order-container');
            
            // Clear previous options
            lineSelect.innerHTML = '<option value="">-- Select a line --</option>';
            stopOrderContainer.style.display = 'none';
            
            // Find the dataset that matches this year_side
            for (const datasetId in datasets) {
                if (datasets[datasetId].yearSide === yearSide && datasets[datasetId].linesData) {
                    // Add line options
                    datasets[datasetId].linesData.forEach(line => {
                        const option = document.createElement('option');
                        option.value = line.line_id;
                        option.textContent = `${line.line_name} (${line.type})`;
                        lineSelect.appendChild(option);
                    });
                    break;
                }
            }
        });
        
        // Line selection for new station
        document.getElementById('new-station-line').addEventListener('change', function() {
            const lineId = this.value;
            const yearSide = document.getElementById('new-station-year-side').value;
            const stopOrderContainer = document.getElementById('stop-order-container');
            const stopOrderSelect = document.getElementById('new-station-stop-order');
            
            if (lineId && yearSide) {
                // Get line details and insertion points
                fetch(`/get_line_details/${yearSide}/${lineId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Clear and populate stop order options
                            stopOrderSelect.innerHTML = '';
                            
                            data.insertion_points.forEach(point => {
                                const option = document.createElement('option');
                                option.value = point.stop_order;
                                option.textContent = `${point.stop_order}. ${point.description}`;
                                stopOrderSelect.appendChild(option);
                            });
                            
                            stopOrderContainer.style.display = 'block';
                            
                            // Show line information
                            const lineInfoDiv = document.getElementById('line-info-display') || createLineInfoDisplay();
                            lineInfoDiv.innerHTML = `
                                <h4>Line Information</h4>
                                <p><strong>Current stops:</strong> ${data.stops.length}</p>
                                <div class="current-stops">
                                    ${data.stops.map(stop => 
                                        `<div class="stop-item">${stop.stop_order}. ${stop.name}</div>`
                                    ).join('')}
                                </div>
                            `;
                        } else {
                            showToast(`Error loading line details: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching line details:', error);
                        showToast('Error loading line details', 'error');
                    });
            } else {
                stopOrderContainer.style.display = 'none';
            }
        });

        // Helper function to create line info display
        function createLineInfoDisplay() {
            const modal = document.getElementById('add-station-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            let lineInfoDiv = document.getElementById('line-info-display');
            if (!lineInfoDiv) {
                lineInfoDiv = document.createElement('div');
                lineInfoDiv.id = 'line-info-display';
                lineInfoDiv.className = 'line-info-display';
                
                // Insert before the create button
                const createButton = document.getElementById('create-station-btn');
                modalContent.insertBefore(lineInfoDiv, createButton);
            }
            
            return lineInfoDiv;
        }

        
        // Create station button
        document.getElementById('create-station-btn').addEventListener('click', function() {
            const name = document.getElementById('new-station-name').value.trim();
            const type = document.getElementById('new-station-type').value;
            const yearSide = document.getElementById('new-station-year-side').value;
            const lineId = document.getElementById('new-station-line').value;
            const stopOrder = document.getElementById('new-station-stop-order').value;
            
            if (!name || !yearSide || !newStationPosition) {
                showToast('Please fill all required fields and set station location', 'error');
                return;
            }
            
            // Prepare station data
            const stationData = {
                year_side: yearSide,
                name: name,
                type: type,
                latitude: newStationPosition.lat,
                longitude: newStationPosition.lng,
                source: 'User added'
            };
            
            // Add line connection if specified
            if (lineId && stopOrder) {
                stationData.line_connections = [{
                    line_id: lineId,
                    stop_order: parseInt(stopOrder)
                }];
            }
            
            // Disable button and show loading state
            this.disabled = true;
            this.textContent = 'Creating station...';
            
            // Send request to server
            fetch('/add_station', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Station added successfully', 'success');
                    
                    // Close modal and reset new station mode
                    document.getElementById('add-station-modal').style.display = 'none';
                    resetNewStationMode();
                    
                    // Reload affected dataset
                    document.getElementById('load-datasets-btn').click();
                } else {
                    showToast(`Error adding station: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding station:', error);
                showToast('Error adding station', 'error');
            })
            .finally(() => {
                this.disabled = false;
                updateCreateButtonState();
            });
        });


        // Helper function to reset new station mode
        function resetNewStationMode() {
            newStationMode = false;
            newStationPosition = null;
            selectedInsertionPoint = null;
            
            // Remove temporary marker
            if (newStationMarker) {
                map.removeLayer(newStationMarker);
                newStationMarker = null;
            }
            
            // Clear form
            document.getElementById('new-station-name').value = '';
            document.getElementById('new-station-type').value = 'ubahn';
            document.getElementById('new-station-year-side').value = '';
            document.getElementById('new-station-line').value = '';
            document.getElementById('new-station-coords').textContent = 'Not set';
            
            // Hide containers
            document.getElementById('stop-order-container').style.display = 'none';
            const lineInfoDiv = document.getElementById('line-info-display');
            if (lineInfoDiv) lineInfoDiv.innerHTML = '';
            const warningDiv = document.getElementById('position-warnings');
            if (warningDiv) warningDiv.style.display = 'none';
            
            updateCreateButtonState();
        }

        // Tab functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // Activate the clicked tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Toggle for full station details
            const detailsToggle = document.getElementById('details-toggle');
            if (detailsToggle) {
                detailsToggle.addEventListener('click', () => {
                    const fullDetails = document.getElementById('full-station-details');
                    const isVisible = fullDetails.style.display === 'block';
                    
                    fullDetails.style.display = isVisible ? 'none' : 'block';
                    detailsToggle.textContent = isVisible ? 'Show Full Details' : 'Hide Full Details';
                    
                    // Switch to tools tab if showing details
                    if (!isVisible) {
                        document.querySelector('.tab-button[data-tab="tools"]').click();
                    }
                });
            }
        });
        
        // Update opacity slider value display
        document.getElementById('opacity-slider').addEventListener('input', function(e) {
            document.getElementById('opacity-value').textContent = `${Math.round(e.target.value * 100)}%`;
            if (historicalLayer) {
                historicalLayer.setOpacity(parseFloat(e.target.value));
            }
        });
        
        // Mobile toggle
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = this.querySelector('.toggle-icon');
            
            sidebar.classList.toggle('mobile-open');
            
            if (sidebar.classList.contains('mobile-open')) {
                toggleIcon.textContent = '▼';
            } else {
                toggleIcon.textContent = '▲';
            }
        });
        
        // Map click handler for new station
        let newStationMarker = null;
        
        map.on('click', function(e) {
            if (newStationMode) {
                const yearSide = document.getElementById('new-station-year-side').value;
                const lineId = document.getElementById('new-station-line').value;
                
                if (!yearSide) {
                    showToast('Please select a dataset first', 'warning');
                    return;
                }
                
                // Set new station position
                newStationPosition = e.latlng;
                
                // Validate position
                const validationData = {
                    year_side: yearSide,
                    latitude: newStationPosition.lat,
                    longitude: newStationPosition.lng
                };
                
                if (lineId) {
                    validationData.line_id = lineId;
                }
                
                fetch('/validate_station_position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(validationData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update coordinate display
                        document.getElementById('new-station-coords').textContent = 
                            `${newStationPosition.lat.toFixed(6)}, ${newStationPosition.lng.toFixed(6)}`;
                        
                        // Show warnings if any
                        if (data.warnings && data.warnings.length > 0) {
                            const warningDiv = document.getElementById('position-warnings') || createPositionWarningsDiv();
                            warningDiv.innerHTML = `
                                <div class="warning-header">⚠️ Position Warnings:</div>
                                ${data.warnings.map(warning => `
                                    <div class="warning-item">
                                        <strong>${warning.message}</strong>
                                        ${warning.stations ? warning.stations.map(station => 
                                            `<div class="nearby-station">• ${station.name} (${station.distance}m away)</div>`
                                        ).join('') : ''}
                                    </div>
                                `).join('')}
                            `;
                            warningDiv.style.display = 'block';
                        } else {
                            const warningDiv = document.getElementById('position-warnings');
                            if (warningDiv) warningDiv.style.display = 'none';
                        }
                        
                        // Add or update temporary marker
                        if (newStationMarker) {
                            newStationMarker.setLatLng(newStationPosition);
                        } else {
                            newStationMarker = L.marker(newStationPosition, {
                                icon: L.divIcon({
                                    html: '<div class="station-marker new-station"></div>',
                                    className: '',
                                    iconSize: [16, 16]
                                })
                            }).addTo(map);
                        }
                        
                        // Enable create button
                        updateCreateButtonState();
                    }
                })
                .catch(error => {
                    console.error('Error validating position:', error);
                    showToast('Error validating station position', 'error');
                });
            }
        });

        // Enhanced create station button with proper validation
        function updateCreateButtonState() {
            const createBtn = document.getElementById('create-station-btn');
            const name = document.getElementById('new-station-name').value.trim();
            const yearSide = document.getElementById('new-station-year-side').value;
            const lineId = document.getElementById('new-station-line').value;
            const stopOrder = document.getElementById('new-station-stop-order').value;
            
            // Enable button if all required fields are filled
            const canCreate = name && yearSide && newStationPosition && 
                            (!lineId || (lineId && stopOrder));
            
            createBtn.disabled = !canCreate;
            
            // Update button text based on state
            if (!name) {
                createBtn.textContent = 'Enter station name';
            } else if (!yearSide) {
                createBtn.textContent = 'Select dataset';
            } else if (!newStationPosition) {
                createBtn.textContent = 'Click map to set location';
            } else if (lineId && !stopOrder) {
                createBtn.textContent = 'Select position on line';
            } else {
                createBtn.textContent = 'Create Station';
            }
        }

        // Add event listeners for form validation
        document.getElementById('new-station-name').addEventListener('input', updateCreateButtonState);
        document.getElementById('new-station-year-side').addEventListener('change', updateCreateButtonState);
        document.getElementById('new-station-line').addEventListener('change', updateCreateButtonState);
        document.getElementById('new-station-stop-order').addEventListener('change', updateCreateButtonState);

        // Helper function to create position warnings display
        function createPositionWarningsDiv() {
            const modal = document.getElementById('add-station-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            let warningDiv = document.getElementById('position-warnings');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'position-warnings';
                warningDiv.className = 'position-warnings';
                
                // Insert after coordinates display
                const coordsDisplay = document.getElementById('new-station-coords');
                coordsDisplay.parentNode.insertBefore(warningDiv, coordsDisplay.nextSibling);
            }
            
            return warningDiv;
        }

        // Distance validation functionality
        let distanceValidationResults = [];

        // Add to the Tools tab in your HTML
        function addDistanceValidationToHTML() {
            // Add this to your tools tab
            const toolsTab = document.getElementById('tools-tab');
            
            const validationSection = document.createElement('div');
            validationSection.className = 'control-group';
            validationSection.innerHTML = `
                <h3>Distance Validation</h3>
                <button id="validate-distances-btn" class="secondary-button">Check Station Distances</button>
                <div id="validation-results" class="validation-results" style="display: none;"></div>
                <div id="validation-status" class="status-indicator"></div>
            `;
            
            toolsTab.appendChild(validationSection);
        }

        // Distance validation functionality
        function initDistanceValidation() {
            document.getElementById('validate-distances-btn').addEventListener('click', function() {
                // Get the primary dataset
                const primaryDataset = datasets[1];
                if (!primaryDataset.yearSide) {
                    showToast('Please load a primary dataset first', 'error');
                    return;
                }
                
                const statusElement = document.getElementById('validation-status');
                const resultsElement = document.getElementById('validation-results');
                
                statusElement.className = 'status-indicator status-processing';
                statusElement.textContent = 'Validating station distances...';
                statusElement.style.display = 'block';
                
                this.disabled = true;
                
                // Call the backend validation endpoint
                fetch('/validate_distances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year_side: primaryDataset.yearSide,
                        line_id: primaryDataset.lineFilter !== 'all' ? primaryDataset.lineFilter : null
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        distanceValidationResults = data.issues;
                        displayValidationResults(data.issues);
                        
                        statusElement.className = 'status-indicator status-success';
                        statusElement.textContent = `Validation complete. Found ${data.issues.length} issues.`;
                        
                        // Highlight problematic stations on map
                        highlightProblematicStations(data.issues);
                    } else {
                        statusElement.className = 'status-indicator status-error';
                        statusElement.textContent = `Validation error: ${data.message}`;
                    }
                    
                    this.disabled = false;
                })
                .catch(error => {
                    console.error('Error validating distances:', error);
                    statusElement.className = 'status-indicator status-error';
                    statusElement.textContent = 'Error during validation';
                    this.disabled = false;
                });
            });
        }

        function displayValidationResults(issues) {
            const resultsElement = document.getElementById('validation-results');
            
            if (issues.length === 0) {
                resultsElement.innerHTML = '<div class="validation-success">✓ All station distances look good!</div>';
                resultsElement.style.display = 'block';
                return;
            }
            
            // Group issues by severity
            const groupedIssues = {
                error: issues.filter(issue => issue.severity === 'error'),
                warning: issues.filter(issue => issue.severity === 'warning'),
                info: issues.filter(issue => issue.severity === 'info')
            };
            
            let html = '<div class="validation-results-content">';
            
            // Display errors first
            if (groupedIssues.error.length > 0) {
                html += '<h4 class="validation-section-header error">🚨 Critical Issues</h4>';
                groupedIssues.error.forEach(issue => {
                    html += formatValidationIssue(issue);
                });
            }
            
            // Then warnings
            if (groupedIssues.warning.length > 0) {
                html += '<h4 class="validation-section-header warning">⚠️ Warnings</h4>';
                groupedIssues.warning.forEach(issue => {
                    html += formatValidationIssue(issue);
                });
            }
            
            // Finally info items
            if (groupedIssues.info.length > 0) {
                html += '<h4 class="validation-section-header info">ℹ️ Suggestions</h4>';
                groupedIssues.info.forEach(issue => {
                    html += formatValidationIssue(issue);
                });
            }
            
            html += '</div>';
            
            resultsElement.innerHTML = html;
            resultsElement.style.display = 'block';
            
            // Add click handlers for validation items
            resultsElement.querySelectorAll('.validation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const stationId = this.getAttribute('data-station-id');
                    if (stationId) {
                        focusOnStation(stationId);
                    }
                });
            });
        }

        function formatValidationIssue(issue) {
            const severityClass = `validation-item-${issue.severity}`;
            const distanceText = issue.distance ? `(${(issue.distance / 1000).toFixed(2)}km)` : '';
            
            return `
                <div class="validation-item ${severityClass}" data-station-id="${issue.station1?.id}">
                    <div class="validation-item-header">
                        <span class="validation-line">${issue.line_name || issue.line_id}</span>
                        <span class="validation-distance">${distanceText}</span>
                    </div>
                    <div class="validation-message">${issue.message}</div>
                    <div class="validation-stations">
                        ${issue.station1?.name} → ${issue.station2?.name}
                    </div>
                </div>
            `;
        }

        function highlightProblematicStations(issues) {
            // Create a set of problematic station IDs
            const problematicStations = new Set();
            issues.forEach(issue => {
                if (issue.station1?.id) problematicStations.add(issue.station1.id);
                if (issue.station2?.id) problematicStations.add(issue.station2.id);
            });
            
            // Update markers to highlight problematic stations
            for (const datasetId in datasets) {
                const dataset = datasets[datasetId];
                if (dataset.yearSide) {
                    dataset.markers.eachLayer(marker => {
                        const stationId = marker.feature.properties.stop_id;
                        const isProblematic = problematicStations.has(stationId);
                        const isSelected = selectedMarker === marker;
                        const isCorrected = marker.feature.properties.corrected;
                        
                        // Create a modified color for problematic stations
                        let markerColor = dataset.color;
                        if (isProblematic) {
                            // Add a red tint to problematic stations
                            markerColor = '#ff6b6b'; // Red color for problematic stations
                        }
                        
                        marker.setIcon(createMarkerIcon(markerColor, isSelected, isCorrected));
                        
                        // Add a pulsing effect for problematic stations
                        if (isProblematic) {
                            marker.getElement()?.classList.add('problematic-station');
                        }
                    });
                }
            }
        }

        function focusOnStation(stationId) {
            // Find and focus on a specific station
            for (const datasetId in datasets) {
                const dataset = datasets[datasetId];
                if (dataset.yearSide) {
                    dataset.markers.eachLayer(marker => {
                        if (marker.feature.properties.stop_id === stationId) {
                            // Pan to station and select it
                            const coords = [
                                marker.feature.geometry.coordinates[1],
                                marker.feature.geometry.coordinates[0]
                            ];
                            map.setView(coords, 16);
                            selectStation(marker.feature, marker);
                            return;
                        }
                    });
                }
            }
        }

        // Enhanced station addition with distance warnings
        function enhanceStationAddition() {
            const createButton = document.getElementById('create-station-btn');
            const originalCreateHandler = createButton.onclick;
            
            createButton.onclick = function() {
                // Before creating, check if the new station is too close to existing ones
                if (newStationPosition) {
                    const nearbyStations = checkNearbyStations(newStationPosition);
                    if (nearbyStations.length > 0) {
                        const message = `Warning: New station is close to existing stations:\n${nearbyStations.map(s => `• ${s.name} (${s.distance}m away)`).join('\n')}\n\nContinue anyway?`;
                        if (!confirm(message)) {
                            return;
                        }
                    }
                }
                
                // Proceed with original creation
                if (originalCreateHandler) {
                    originalCreateHandler.call(this);
                }
            };
        }

        function checkNearbyStations(position, maxDistance = 300) {
            const nearbyStations = [];
            
            for (const datasetId in datasets) {
                const dataset = datasets[datasetId];
                if (dataset.data && dataset.data.geojson) {
                    dataset.data.geojson.features.forEach(feature => {
                        const stationLat = feature.geometry.coordinates[1];
                        const stationLng = feature.geometry.coordinates[0];
                        
                        const distance = calculateDistance(
                            position.lat, position.lng,
                            stationLat, stationLng
                        );
                        
                        if (distance <= maxDistance) {
                            nearbyStations.push({
                                name: feature.properties.name,
                                distance: Math.round(distance)
                            });
                        }
                    });
                }
            }
            
            return nearbyStations.sort((a, b) => a.distance - b.distance);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Simple Haversine distance calculation
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        
            
        // Function to update the historical layer
        function updateHistoricalLayer() {
            // Check if historical layer is enabled
            if (!document.getElementById('historic-layer').checked) {
                return;
            }
            
            // Remove existing historical layer if it exists
            if (historicalLayer && map.hasLayer(historicalLayer)) {
                map.removeLayer(historicalLayer);
                historicalLayer = null;
            }
            
            // Get selected historical map
            const historicMapSelect = document.getElementById('historic-map-select');
            const selectedOption = historicMapSelect.options[historicMapSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                return;
            }
            
            // Find the tile set data
            const tileSetName = selectedOption.value;
            const tileSet = availableTileSets.find(ts => ts.name === tileSetName);
            
            if (!tileSet) {
                console.error('Selected tile set not found:', tileSetName);
                return;
            }
            
            console.log('Adding historical layer:', tileSet);
            
            // Get the opacity value
            const opacity = parseFloat(document.getElementById('opacity-slider').value);
            
            // Create and add layer
            historicalLayer = L.tileLayer(tileSet.url, {
                attribution: 'Historical Map - ' + tileSet.name,
                minZoom: Math.min(...tileSet.zoom_levels),
                maxZoom: Math.max(...tileSet.zoom_levels),
                opacity: opacity
            }).addTo(map);
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                document.body.removeChild(toast);
            });
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }, 100);
        }
        
        // Update the add station modal dataset select
        function updateAddStationDatasetSelect() {
            const select = document.getElementById('new-station-year-side');
            select.innerHTML = '';
            
            // Add options for active datasets
            for (const datasetId in datasets) {
                if (datasets[datasetId].yearSide) {
                    const option = document.createElement('option');
                    option.value = datasets[datasetId].yearSide;
                    option.textContent = datasets[datasetId].yearSide;
                    select.appendChild(option);
                }
            }
        }
        
        // Display dataset markers on map
        function displayDataset(datasetId) {
            const dataset = datasets[datasetId];
            
            // Clear previous markers
            dataset.markers.clearLayers();
            
            if (!dataset.data || !dataset.data.geojson || !dataset.data.geojson.features) {
                return;
            }
            
            // Create markers for each station
            dataset.data.geojson.features.forEach(feature => {
                // Create marker
                const marker = L.marker([
                    feature.geometry.coordinates[1],  // latitude
                    feature.geometry.coordinates[0]   // longitude
                ], {
                    draggable: true,
                    title: feature.properties.name,
                    icon: createMarkerIcon(dataset.color, false, feature.properties.corrected)
                });
                
                marker.feature = feature;
                marker.datasetId = datasetId;
                
                // Handle marker click
                marker.on('click', function(e) {
                    selectStation(feature, marker);
                });
                
                // Handle marker drag
                marker.on('dragend', function(e) {
                    const latlng = e.target.getLatLng();
                    markerDraggedPosition = latlng;
                    document.getElementById('save-correction').style.display = 'block';
                    
                    // Update marker icon to indicate it's been moved
                    const isSelected = selectedMarker === marker;
                    const isCorrected = feature.properties.corrected;
                    marker.setIcon(createMarkerIcon(dataset.color, isSelected, isCorrected));
                    
                    // Update station details display
                    updateStationDetails();
                });
                
                // Add marker to layer
                dataset.markers.addLayer(marker);
            });
        }
        
        // Update markers for a dataset (e.g., when color changes)
        function updateDatasetMarkers(datasetId) {
            const dataset = datasets[datasetId];
            
            // Update all markers in the layer
            dataset.markers.eachLayer(marker => {
                const isSelected = selectedMarker === marker;
                const isCorrected = marker.feature.properties.corrected;
                marker.setIcon(createMarkerIcon(dataset.color, isSelected, isCorrected));
            });
        }
        
        // Update station list for a specific dataset
        function updateStationList(datasetId) {
            const stationList = document.getElementById('station-list');
            stationList.innerHTML = '';
            
            const dataset = datasets[datasetId];
            
            if (!dataset.yearSide || !dataset.data || !dataset.data.geojson || !dataset.data.geojson.features) {
                stationList.innerHTML = '<div class="no-data-message">No stations to display</div>';
                return;
            }
            
            // Create list items for each station
            dataset.data.geojson.features.forEach(feature => {
                const stationId = feature.properties.stop_id;
                const stationName = feature.properties.name;
                const stationType = feature.properties.type;
                const stationLine = feature.properties.line;
                const isCorrected = feature.properties.corrected;
                
                // Find corresponding marker
                let marker = null;
                dataset.markers.eachLayer(m => {
                    if (m.feature.properties.stop_id === stationId) {
                        marker = m;
                    }
                });
                
                if (!marker) return;
                
                // Create list item with improved structure
                const listItem = document.createElement('div');
                listItem.className = `station-item${isCorrected ? ' corrected' : ''}`;
                listItem.setAttribute('data-id', stationId);
                listItem.setAttribute('data-name', stationName);
                
                // Add color indicator based on dataset color
                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'color-indicator';
                colorIndicator.style.backgroundColor = dataset.color;
                
                // Add transport type indicator
                const typeSpan = document.createElement('span');
                typeSpan.className = `transport-type type-${stationType.replace(/\s+/g, '')}`;
                typeSpan.textContent = stationType.charAt(0).toUpperCase();
                
                // Add station details container
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'station-details';
                
                // Add station name
                const nameDiv = document.createElement('div');
                nameDiv.className = 'station-name';
                nameDiv.textContent = stationName;
                
                // Add line info
                const lineDiv = document.createElement('div');
                lineDiv.className = 'station-line';
                lineDiv.textContent = stationLine || 'No line';
                
                // Assemble the structure
                detailsDiv.appendChild(nameDiv);
                detailsDiv.appendChild(lineDiv);
                
                listItem.appendChild(colorIndicator);
                listItem.appendChild(typeSpan);
                listItem.appendChild(detailsDiv);
                
                // Handle list item click
                listItem.addEventListener('click', function() {
                    selectStation(feature, marker);
                    map.setView([feature.geometry.coordinates[1], feature.geometry.coordinates[0]], 17);
                });
                
                stationList.appendChild(listItem);
            });
            
            // Set active dataset in switcher
            document.querySelectorAll('#station-list-datasets .btn').forEach(btn => {
                const btnDatasetId = btn.getAttribute('data-dataset');
                if (btnDatasetId === datasetId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update button labels to show actual dataset names
            document.querySelectorAll('#station-list-datasets .btn').forEach(btn => {
                const btnDatasetId = btn.getAttribute('data-dataset');
                const yearSide = datasets[btnDatasetId].yearSide;
                btn.textContent = yearSide || `Dataset ${btnDatasetId}`;
            });
        }
        
        // Select a station
        function selectStation(feature, marker) {
            // Reset previous selection
            if (selectedMarker) {
                const prevDatasetId = selectedMarker.datasetId;
                const prevDataset = datasets[prevDatasetId];
                const prevIsCorrected = selectedMarker.feature.properties.corrected;
                selectedMarker.setIcon(createMarkerIcon(prevDataset.color, false, prevIsCorrected));
            }
            
            // Set new selection
            selectedStation = feature;
            selectedMarker = marker;
            
            // Find which dataset this marker belongs to
            const datasetId = marker.datasetId;
            const dataset = datasets[datasetId];
            
            // Update marker icon
            const isCorrected = feature.properties.corrected;
            marker.setIcon(createMarkerIcon(dataset.color, true, isCorrected));
            
            // Reset state
            markerDraggedPosition = null;
            nameChanged = false;
            originalName = null;
            
            // Show relevant buttons
            document.getElementById('save-correction').style.display = 'none';
            document.getElementById('delete-station').style.display = 'block';
            document.getElementById('current-station').style.display = 'block';
            
            // Highlight in list
            const stationItems = document.querySelectorAll('.station-item');
            stationItems.forEach(item => {
                item.classList.remove('selected');
                if (item.getAttribute('data-id') == feature.properties.stop_id) {
                    item.classList.add('selected');
                    // Scroll to the selected item
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            
            updateStationDetails();
        }

        // Replace the existing name editing initialization function with this:
        let originalName = null;
        let nameChanged = false;

        function initNameEditing() {
            const nameInput = document.getElementById('station-name-input');
            const editButton = document.getElementById('edit-name-btn');
            const saveNameButton = document.getElementById('save-name-btn');
            
            // Toggle edit mode
            editButton.addEventListener('click', function() {
                if (nameInput.disabled) {
                    // Enable editing
                    nameInput.disabled = false;
                    nameInput.focus();
                    editButton.textContent = 'Cancel';
                    saveNameButton.style.display = 'inline';
                    originalName = nameInput.value;
                } else {
                    // Cancel editing
                    nameInput.disabled = true;
                    nameInput.value = originalName;
                    editButton.textContent = 'Edit';
                    saveNameButton.style.display = 'none';
                    nameChanged = false;
                    nameInput.classList.remove('changed');
                }
            });
            
            // Track changes
            nameInput.addEventListener('input', function() {
                nameChanged = nameInput.value !== originalName;
                
                if (nameChanged) {
                    nameInput.classList.add('changed');
                    saveNameButton.style.display = 'inline';
                } else {
                    nameInput.classList.remove('changed');
                    saveNameButton.style.display = 'none';
                }
            });
            
            // Add event listener for the save name button
            saveNameButton.addEventListener('click', function() {
                if (!selectedStation || !nameChanged) return;
                
                const yearSide = selectedStation.properties.year_side;
                const nameInput = document.getElementById('station-name-input');
                
                // Save name correction
                fetch('/save_name_correction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        year_side: yearSide,
                        stop_id: selectedStation.properties.stop_id,
                        name: nameInput.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showToast('Station name saved successfully!', 'success');
                    
                    // Update local corrections
                    if (!corrections[yearSide]) {
                        corrections[yearSide] = {};
                    }
                    
                    if (!corrections[yearSide][selectedStation.properties.stop_id]) {
                        corrections[yearSide][selectedStation.properties.stop_id] = {};
                    }
                    
                    // Get existing lat/lng if available, or use original coordinates
                    const existingCorrection = corrections[yearSide][selectedStation.properties.stop_id];
                    const lat = existingCorrection.lat || selectedStation.geometry.coordinates[1];
                    const lng = existingCorrection.lng || selectedStation.geometry.coordinates[0];
                    
                    corrections[yearSide][selectedStation.properties.stop_id] = {
                        lat: lat,
                        lng: lng,
                        name: nameInput.value
                    };
                    
                    // Update station properties for display
                    selectedStation.properties.name = nameInput.value;
                    
                    // Refresh display
                    for (const datasetId in datasets) {
                        if (datasets[datasetId].yearSide === yearSide) {
                            displayDataset(datasetId);
                        }
                    }
                    
                    // Reset state
                    nameChanged = false;
                    nameInput.disabled = true;
                    editButton.textContent = 'Edit';
                    saveNameButton.style.display = 'none';
                    
                    // Update station details and list
                    updateStationDetails();
                    const activeDatasetBtn = document.querySelector('#station-list-datasets .btn.active');
                    if (activeDatasetBtn) {
                        updateStationList(activeDatasetBtn.getAttribute('data-dataset'));
                    }
                })
                .catch(error => {
                    console.error('Error saving name correction:', error);
                    showToast('Error saving station name', 'error');
                });
            });
        }

        // Add CSS for new elements
        const additionalCSS = `
        .line-info-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .current-stops {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }

        .stop-item {
            padding: 0.25rem 0;
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
        }

        .stop-item:last-child {
            border-bottom: none;
        }

        .position-warnings {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            display: none;
        }

        .warning-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #856404;
        }

        .warning-item {
            margin-bottom: 0.5rem;
        }

        .nearby-station {
            font-size: 0.85rem;
            color: #6c757d;
            margin-left: 1rem;
        }
        `;

        // Add the CSS to the page
        const style = document.createElement('style');
        style.textContent = additionalCSS;
        document.head.appendChild(style);

        // Add CSS for validation styling
        function addValidationCSS() {
            const style = document.createElement('style');
            style.textContent = `
                .validation-results {
                    max-height: 400px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-top: 1rem;
                }
                
                .validation-results-content {
                    padding: 1rem;
                }
                
                .validation-section-header {
                    margin: 1rem 0 0.5rem 0;
                    font-size: 0.9rem;
                    font-weight: 600;
                }
                
                .validation-section-header.error {
                    color: #d32f2f;
                }
                
                .validation-section-header.warning {
                    color: #f57c00;
                }
                
                .validation-section-header.info {
                    color: #1976d2;
                }
                
                .validation-item {
                    padding: 0.75rem;
                    margin-bottom: 0.5rem;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: background-color 0.2s;
                }
                
                .validation-item:hover {
                    background-color: #f5f5f5;
                }
                
                .validation-item-error {
                    border-left: 4px solid #d32f2f;
                    background-color: #ffebee;
                }
                
                .validation-item-warning {
                    border-left: 4px solid #f57c00;
                    background-color: #fff8e1;
                }
                
                .validation-item-info {
                    border-left: 4px solid #1976d2;
                    background-color: #e3f2fd;
                }
                
                .validation-item-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 0.25rem;
                }
                
                .validation-line {
                    font-weight: 600;
                    font-size: 0.9rem;
                }
                
                .validation-distance {
                    font-size: 0.8rem;
                    color: #666;
                    font-family: monospace;
                }
                
                .validation-message {
                    font-size: 0.85rem;
                    margin-bottom: 0.25rem;
                }
                
                .validation-stations {
                    font-size: 0.8rem;
                    color: #666;
                    font-style: italic;
                }
                
                .validation-success {
                    padding: 1rem;
                    background-color: #e8f5e9;
                    color: #2e7d32;
                    text-align: center;
                    border-radius: 4px;
                }
                
                .problematic-station {
                    animation: pulse-red 2s infinite;
                }
                
                @keyframes pulse-red {
                    0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
                    70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
                }
            `;
            document.head.appendChild(style);
        }

        document.addEventListener('DOMContentLoaded', function() {
        // Add validation CSS
        addValidationCSS();
        
        // Add distance validation section to tools tab
        addDistanceValidationToHTML();
        
        // Initialize distance validation
        initDistanceValidation();
        
        // Enhance station addition
        enhanceStationAddition();
        
        // Initialize existing functionality
        initNameEditing();
        initSourceEditing();
    });

        
        // Variables for source editing
        let originalSource = null;
        let sourceChanged = false;

        function initSourceEditing() {
            const sourceInput = document.getElementById('station-source-input');
            const editSourceButton = document.getElementById('edit-source-btn');
            const saveSourceButton = document.getElementById('save-source-btn');
            
            // Toggle edit mode for source
            editSourceButton.addEventListener('click', function() {
                if (sourceInput.disabled) {
                    // Enable editing
                    sourceInput.disabled = false;
                    sourceInput.focus();
                    editSourceButton.textContent = 'Cancel';
                    saveSourceButton.style.display = 'inline';
                    originalSource = sourceInput.value;
                } else {
                    // Cancel editing
                    sourceInput.disabled = true;
                    sourceInput.value = originalSource;
                    editSourceButton.textContent = 'Edit';
                    saveSourceButton.style.display = 'none';
                    sourceChanged = false;
                    sourceInput.classList.remove('changed');
                }
            });
            
            // Track changes
            sourceInput.addEventListener('input', function() {
                sourceChanged = sourceInput.value !== originalSource;
                
                if (sourceChanged) {
                    sourceInput.classList.add('changed');
                    saveSourceButton.style.display = 'inline';
                } else {
                    sourceInput.classList.remove('changed');
                    saveSourceButton.style.display = 'none';
                }
            });
            
            // Save source changes
            saveSourceButton.addEventListener('click', function() {
                if (!selectedStation || !sourceChanged) return;
                
                const sourceInput = document.getElementById('station-source-input');
                const newSource = sourceInput.value.trim();
                
                if (!newSource) {
                    showToast('Source cannot be empty', 'error');
                    return;
                }
                
                // Save source correction
                fetch('/save_source_correction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stop_id: selectedStation.properties.stop_id,
                        source: newSource
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Station source saved successfully!', 'success');
                        
                        // Update the station properties
                        selectedStation.properties.source = newSource;
                        
                        // Reset state
                        sourceChanged = false;
                        sourceInput.disabled = true;
                        editSourceButton.textContent = 'Edit';
                        saveSourceButton.style.display = 'none';
                        sourceInput.classList.remove('changed');
                        
                        // Update station details display
                        updateStationDetails();
                        
                        showToast('Source updated successfully', 'success');
                    } else {
                        showToast(`Error saving source: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving source correction:', error);
                    showToast('Error saving station source', 'error');
                });
            });
        }

        // Update station details display
        function updateStationDetails() {
            if (!selectedStation) return;
            
            const stationDetails = document.getElementById('station-details');
            
            // Get the year_side for this station
            const yearSide = selectedStation.properties.year_side;
            
            // Update info in the compact view
            document.getElementById('selected-station-name').textContent = selectedStation.properties.name;
            document.getElementById('selected-station-year-side').textContent = yearSide;
            
            // Get original coordinates
            const originalLat = selectedStation.geometry.coordinates[1];
            const originalLng = selectedStation.geometry.coordinates[0];
            
            // Get corrected coordinates if available
            let correctedPosition = null;
            let correctedName = null;
            if (corrections[yearSide]?.[selectedStation.properties.stop_id]) {
                const correction = corrections[yearSide][selectedStation.properties.stop_id];
                correctedPosition = {lat: correction.lat, lng: correction.lng};
                correctedName = correction.name;
            }
            
            // Use dragged position if available, otherwise use corrected or original
            const currentPosition = markerDraggedPosition || 
                        (correctedPosition ? {lat: correctedPosition.lat, lng: correctedPosition.lng} : 
                        {lat: originalLat, lng: originalLng});
            
            // Update coordinates in compact view
            document.getElementById('selected-station-coords').textContent = 
                `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
            
            // Format the status message
            let statusMessage = '';
            const statusElement = document.getElementById('selected-station-status');
            
            if (markerDraggedPosition) {
                statusMessage = '<div class="status-tag status-modified">Modified (Unsaved)</div>';
                statusElement.className = 'status-tag status-modified';
                statusElement.textContent = 'Modified (Unsaved)';
            } else if (correctedPosition) {
                statusMessage = '<div class="status-tag status-corrected">Corrected</div>';
                statusElement.className = 'status-tag status-corrected';
                statusElement.textContent = 'Corrected';
            } else {
                statusMessage = '<div class="status-tag status-original">Original</div>';
                statusElement.className = 'status-tag status-original';
                statusElement.textContent = 'Original';
            }

            const displayName = correctedName || selectedStation.properties.name;
            const stationSource = selectedStation.properties.source || 'Not specified';
            
            stationDetails.innerHTML = `
                <div class="detail-header">
                    <h4>${displayName}</h4>
                    ${statusMessage}
                </div>
                <div class="detail-info">
                    <div class="detail-row">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">${selectedStation.properties.stop_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Dataset:</span>
                        <span class="detail-value">${yearSide}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${selectedStation.properties.type}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Line:</span>
                        <span class="detail-value">${selectedStation.properties.line || 'None'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Source:</span>
                        <span class="detail-value">${stationSource}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Original:</span>
                        <span class="detail-value coord">${originalLat.toFixed(6)}, ${originalLng.toFixed(6)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current:</span>
                        <span class="detail-value coord">${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}</span>
                    </div>
                </div>
            `;
            
            // Update name input
            const nameInput = document.getElementById('station-name-input');
            nameInput.value = displayName;
            nameInput.disabled = true;
            
            // Update source input
            const sourceInput = document.getElementById('station-source-input');
            sourceInput.value = stationSource;
            sourceInput.disabled = true;
            
            // Reset editing states
            document.getElementById('edit-name-btn').textContent = 'Edit';
            document.getElementById('save-name-btn').style.display = 'none';
            document.getElementById('edit-source-btn').textContent = 'Edit';
            document.getElementById('save-source-btn').style.display = 'none';
        }
    </script>
</body>
</html>